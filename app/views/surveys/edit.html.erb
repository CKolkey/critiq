<%= render partial: "shared/sidebar" %>
<div class="main-content">

  <!-- This partial containes stuff that was in the template but I have no -->
  <!-- idea what its for, so it's commented out -->
  <%#= render partial: "shared/dashkit_top_navbar" %>

  <!-- HEADER -->
  <div class="header no-b-margin">
    <div class="container-fluid">

      <!-- Body -->
      <div class="header-body">
        <div class="row align-items-end">
          <div class="col-8">

            <!-- Pretitle -->
            <h6 class="header-pretitle">
              CRITIQ
            </h6>

            <!-- Title -->
            <h1 class="header-title">
              Create
            </h1>

          </div>
          <div class="col-4">

            <!-- Button -->


          </div>
        </div>
        <!-- / .row -->
      </div>
      <!-- / .header-body -->

    </div>
  </div>
  <!-- / .header -->

  <!-- LEFT and RIGHT panes -->
  <div class="container-fluid d-flex overflow-a" style="max-width:900px;">
    <div class="all-questions no-scrollbar">
      <div class="title_and_description mb-3">
        <div class="header-section-survey">
          <div class="header-title-survey">
            <h1 style="margin-top:20px;"><%= @survey.title %></h1>
            <p style="margin-top:20px;"><%= @survey.created_at.strftime("%e %B %Y")%></p>
          </div>
        </div>
        <div class="description-and-button">
          <h3 style="color: grey;"><%= @survey.description %></h3>
          <p class=" btn btn-light display-header-button">Edit Title</p>
        </div>
      </div>
      <%= simple_form_for @survey do |f| %>
      <div class="wrapper-titel-survey-header">
          <div class="wrapper-title-survey">
            <%= f.input :title,
                        wrapper_html: { class: 'title-input-text' }%>
            <%= f.input :description,
                        wrapper_html: { class: 'description-input-text' } %>
        </div>
        <div class="slack-channels d-flex">
          <div class="w-50">
            <h4 style="padding-top:10px;">Get Critiq from your colleagues in:</h4>
          </div>
          <div class="w-50">

            <%= f.collection_select :channel_id,
                  @slackchannels,
                  ->(item) { item[:id] },
                  ->(item) { item[:name].capitalize }
                  %>

          </div>
        </div>
        <h5 class="text-center my-4 text-muted">A message will be sent to <strong>each member</strong> of the group <strong>individually</strong>.</h5>
        </div>
        <!-- nested form for creating questions -->
        <div id="questions">
          <%= f.simple_fields_for :questions do |f| %>
            <%= render 'question_fields', f: f %>
          <% end %>

            <div class="links">
                   <!-- IS THIS NEEDED?
              <%#= link_to_add_association 'add question', f, :questions, class:"btn btn-primary" %>
               <%= link_to_add_association '<i class="fas fa-plus-circle"></i>'.html_safe, f, :questions, class:"question-icon" %>
            </div>
            <div class="send-save-buttons text-right" style="margin-bottom: 70px;">
              <%= f.submit "Send", class:"btn btn-primary create-survey-button-edit create-survey-button-edit-send" %>
              <%= f.submit "Save", class:"btn btn-light create-survey-button-edit" %> -->

               <%= link_to_add_association '<i class="fas fa-plus-circle"></i>'.html_safe, f, :questions, class:"question-icon plusButtonMover" %>
            </div>

        </div>
        <%= f.input :published, :as => :hidden, :input_html => { :value => "true" } %>

        <div class="form-create-footer text-right px-5">
          <span class="text-left">
          </span>
          <span class="text-right">
            <%= f.submit "Save", class:"btn btn-primary create-survey-button-edit send-button-mover btn-ease" %>
            <%= f.submit "Send & Save", class:"btn btn-start-crit create-survey-button-edit sendAndSavebtn btn-ease" %>
          </span>
        </div>
      <% end %>
    </div>



  </div>
</div>

<!-- END  -->
<%= content_for :after_js do %>
  <script>
    const clickPlus = () => {
      document.querySelector('.question-icon').click()
    };

    const disableButtonOnLoad = () => {
      const inputField = document.querySelectorAll('input[id*=survey_questions]')[0];
      if (inputField) {
        if (inputField.value.length == 0) {
          document.querySelectorAll('.create-survey-button-edit')[0].disabled = true;
          document.querySelectorAll('.create-survey-button-edit')[1].disabled = true;
        }
      }
    };

    const disableButtons = () => {
      const buttonSave = document.querySelectorAll('.create-survey-button-edit')[0];
      const buttonSend = document.querySelectorAll('.create-survey-button-edit')[1];
      const inputField = document.querySelectorAll('input[id*=survey_questions]')[0];

      if (buttonSave && buttonSend && inputField) {
        inputField.addEventListener('keyup', (event) => {
          if (inputField.value.length > 0) {
            buttonSave.disabled = false;
            buttonSend.disabled = false;
          } else {
            buttonSave.disabled = true;
            buttonSend.disabled = true;
          }
        });
      }
    };


    $( document ).ready(function(){
      clickPlus();
      disableButtonOnLoad();
      disableButtons();
    })

    $('#questions').on('cocoon:after-insert', function(e, insertedItem) {
      if (insertedItem.length === 5 && insertedItem[4].id === "choices") {
        let addedDropdown = insertedItem[2].lastElementChild.children["0"].children[1]
        let associatedChoiceBtn = insertedItem[4].lastElementChild
        let n = document.querySelectorAll('.select.optional.form-control').length
        insertedItem[4].classList.add(`mc-choices-${n}`);
        insertedItem[2].classList.add(`mc-choices-${n}`);
        addedDropdown.addEventListener('change', function(event) {
          if (this.value === "radio"){
            associatedChoiceBtn.classList.remove("mc-hidden");
            insertedItem[4].classList.add("mc-choice-bump-height");
          } else {
            associatedChoiceBtn.classList.add("mc-hidden");
            insertedItem[4].classList.remove("mc-choice-bump-height");
          };
        })
      }
    });
    $('#questions').on('cocoon:after-remove', function(e, insertedItem) {
      let kill = `.${insertedItem["0"].classList[1]}`
      document.querySelector(kill).remove();
    });
  </script>
<% end %>
